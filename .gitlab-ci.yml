stages:
  - build

variables:
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/mksmolnb/${CI_COMMIT_TAG}"
  IMG: "rescue"
  UPURL: "${PACKAGE_REGISTRY_URL}/${IMG}.img"
  DEFARCH: "amd64"
  DEFVERS: "10"
  DEFSETS: "rescue.tar.xz"
  DEFSIZE: "20"


build_img:
  image: debian:latest
  stage: build
  script:
    - apt update && apt install -y curl xz-utils
    - rm -rf /var/cache
    - |
      [ -z "${SETS}" ] && SETS=${DEFSETS}
      [ -z "${VERS}" ] && VERS=${DEFVERS}
      [ -z "${ARCH}" ] && ARCH=${DEFARCH}
      [ -z "${SIZE}" ] && SIZE=${DEFSIZE}
      mkdir -p sets
      DIST="https://nycdn.netbsd.org/pub/NetBSD-daily/netbsd-${VERS}/latest/${ARCH}/binary/sets"
      for set in ${SETS}
      do
        curl -L -O --output-dir sets ${DIST}/${set}
      done
    - chmod +x mkimg.sh
    - ./mkimg.sh -x ${SETS} -m ${SIZE}
  artifacts:
    name: "${IMG}"
    paths:
      - ${IMG}.img
