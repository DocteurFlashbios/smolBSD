stages:
  - build
  - release

variables:
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/mksmolnb/${CI_COMMIT_TAG}"
  IMG: "rescue"
  UPURL: "${PACKAGE_REGISTRY_URL}/${IMG}.img"
  VERS: "10"
  ARCH: "amd64"
  DIST: "https://nycdn.netbsd.org/pub/NetBSD-daily/netbsd-${VERS}/latest/${ARCH}/binary/sets"
  SETS: "rescue.tar.xz"


build_img:
  image: alpine:latest
  stage: build
  script:
    - apk add --no-cache curl xz e2fsprogs
    - mkdir -p sets/${ARCH}
    - |
      for set in ${SETS}
      do
        echo "fetching: ${DIST}/${set}"
        curl -L -O --output-dir sets/${ARCH} ${DIST}/${set}
      done
    - chmod +x mkimg.sh
    - ./mkimg.sh 
  artifacts:
    name: "${IMG}"
    paths:
      - ${IMG}.img

release_img:
  stage: release
  image: curlimages/curl:latest
  script:
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file ${IMG}.img "${UPURL}"



